## Задание практической работы №5
### Часть 1. Измерительные и исполнительные устройства стенда
Ознакомьтесь с устройствами в составе стенда и их характеристиками.

![](../images/Pasted%20image%2020241118160540.png)

Опишите датчики и исполнительные устройства, согласно своему варианту:
#### Вариант 6
1. Модуль обнаружения протечек WB-MWAC (10)
2. Качество воздуха VOC в составе устройства WB-MSW v.3 (5)
3. Датчик протечки (23)

В отчете необходимо отразить:
1. Название датчика/устройства;
2. Тип измерения (цифровой/аналоговый);
3. Измеряемые параметры и диапазон измерения;
4. Точность;
5. Напряжение питания;
6. Уникальный идентификатор датчика в веб-интерфейсе;
7. Использующийся протокол передачи данных;
8. Интерфейс управления (шина);
9. Описание входов и выходов, схема подключения.

Примечание 1. Пунты 2-4 обязательные только для датчиков.

------
#### 1. Модуль обнаружения протечек WB-MWAC (10)

1. **Название датчика/устройства**: Модуль обнаружения протечек WB-MWAC
2. **Тип измерения**: Цифровой
3. **Измеряемые параметры и диапазон измерения**:
   - **Обнаружение протечки**: Наличие/отсутствие воды
   - **Температура воздуха**: от -40°C до +125°C
   - **Влажность воздуха**: от 0 до 100% RH
4. **Точность**:
   - **Температура**: ±0.5°C
   - **Влажность**: ±3% RH
5. **Напряжение питания**: 8-24V DC
6. **Уникальный идентификатор датчика в веб-интерфейсе**: device10 (пример)
7. **Использующийся протокол передачи данных**: Modbus RTU, MQTT (через контроллер)
8. **Интерфейс управления (шина)**: RS-485
9. **Описание входов и выходов, схема подключения**:
   - **Входы**: 3 входа для датчиков протечки
   - **Выходы**: 2 реле для управления клапанами (NO, NC)
   - **Схема подключения**: 
     - Подключение к шине RS-485 для связи с контроллером.
     - Датчики протечки подключаются к трём входам на модуле.
     - Выходы реле подключаются к исполнительным механизмам (клапаны).

#### 2. Качество воздуха VOC в составе устройства WB-MSW v.3 (5)

1. **Название датчика/устройства**: WB-MSW v.3
2. **Тип измерения**: Цифровой
3. **Измеряемые параметры и диапазон измерения**:
   - **VOC (Volatile Organic Compounds)**: 0 – 60000 ppb
   - **CO₂ эквивалент**: 400 - 8192 ppm
   - **Температура**: -40°C - 125°C
   - **Влажность**: 0 - 100% RH
   - **Освещенность**: 0 - 83000 Lux
   - **Шум**: 30 - 120 dB
4. **Точность**:
   - **VOC**: Не указано, но обычно ±10% от измеренного значения
   - **Температура**: ±0.5°C
   - **Влажность**: ±3% RH
   - **Освещенность**: ±3% Lux
   - **Шум**: ±3 dB
5. **Напряжение питания**: 10-24V DC
6. **Уникальный идентификатор датчика в веб-интерфейсе**: device5 (пример)
7. **Использующийся протокол передачи данных**: Modbus RTU, MQTT (через контроллер)
8. **Интерфейс управления (шина)**: RS-485
9. **Описание входов и выходов, схема подключения**:
   - **Входы**: Датчики VOC, CO₂, температуры, влажности, освещенности и шума интегрированы в одном корпусе.
   - **Выходы**: Нет дополнительных выходов для управления.
   - **Схема подключения**: 
     - Подключение к шине RS-485 для передачи данных.
     - Питание через вход 10-24V DC.

#### 3. Датчик протечки (23)

1. **Название датчика/устройства**: Датчик протечки (уточнение модели не предоставлено, рассмотрим общие характеристики типичного датчика протечки)
2. **Тип измерения**: Цифровой
3. **Измеряемые параметры и диапазон измерения**:
   - **Обнаружение протечки**: Наличие/отсутствие воды
4. **Точность**: Обычно датчики протечки являются двухуровневыми устройствами без аналогового диапазона, точность не применима.
5. **Напряжение питания**: Часто 5-12V DC
6. **Уникальный идентификатор датчика в веб-интерфейсе**: device23 (пример)
7. **Использующийся протокол передачи данных**: Зависит от системы, может быть Modbus RTU, MQTT или простое цифровое состояние (для простых датчиков)
8. **Интерфейс управления (шина)**: Может быть RS-485 для сложных систем или прямое цифровое подключение (для простых датчиков)
9. **Описание входов и выходов, схема подключения**:
   - **Входы**: Нет входов, кроме самого датчика протечки.
   - **Выходы**: Цифровой сигнал (High/Low), который показывает наличие протечки.
   - **Схема подключения**:
     - Для простого датчика: Обычно два провода подключаются к контроллеру или мониторинговой системе, которая определяет изменение сопротивления или замыкание цепи при контакте с водой.
     - Для более сложных систем: Подключение может идти через RS-485 с использованием протокола Modbus RTU. В таком случае датчик будет иметь два провода для RS-485 плюс провода питания.


Датчики протечки обычно предназначены для обнаружения наличия воды на поверхностях, где её присутствие может привести к ущербу или необходимости аварийного вмешательства. Используются в жилых, коммерческих и промышленных помещениях для защиты от утечек воды из систем отопления, водопровода, канализации и других систем, содержащих жидкости.

В зависимости от модели и производителя, датчики могут иметь различные дополнительные функции, такие как измерение температуры или влажности в месте установки, но базовая функция — это двоичное (да/нет) обнаружение воды.

Для точного определения характеристик и схемы подключения вашего датчика протечки (23) необходимо уточнить модель и производителя, так как детали могут сильно варьироваться в зависимости от этих параметров. Если модель будет предоставлена, можно дать более точные технические детали и схему подключения.

------

### Часть 2. Протоколы работы с устройствами (активно спрашивает, надо допилить!)
Опишите принцип работы, преимущества и недостатки, сферу применения следующих четырех технологий:
1. Modbus RTU
2. 1-Wire
3. I²C (IIC, англ. Inter-Integrated Circuit)
4. CAN.

---

#### 1. Modbus RTU

**Принцип работы:**
Modbus RTU (Remote Terminal Unit) — это бинарный протокол передачи данных, использующийся для связи между электронными устройствами, особенно в автоматизации промышленного оборудования. Протокол работает по принципу "мастер-ведомый" (master-slave), где одно устройство (мастер) инициирует транзакции (запросы), а другие устройства (ведомые) отвечают на них. Данные передаются в виде сообщений, состоящих из адреса ведомого, кода функции (определяющего тип запроса), данных и контрольной суммы (CRC) для проверки ошибок.

**Преимущества:**
- **Простота и надёжность:** Modbus RTU имеет простую структуру сообщений, что облегчает его реализацию и диагностику.
- **Широкая поддержка:** Этот протокол поддерживается множеством устройств и производителей.
- **Низкая стоимость:** Не требует дорогостоящего оборудования для реализации и подключения.
- **Высокая производительность:** Подходит для использования в реальном времени благодаря быстрой скорости передачи данных.

**Недостатки:**
- **Ограниченная длина сети:** Ограничения на длину кабеля могут стать проблемой в больших системах.
- **Нет защиты от дублирования адресов:** Необходимо вручную следить за уникальностью адресов устройств в сети.
- **Отсутствие встроенной шифровки:** Данные передаются открыто, что делает протокол уязвимым к подслушиванию.

**Сфера применения:**
- **Промышленная автоматизация:** Управление механизмами и сбор данных с датчиков.
- **Системы SCADA:** Интеграция с системами управления и сбора данных.
- **Building Management Systems (BMS):** Автоматизация зданий и управление инженерными системами.
- **Умные сети (Smart Grid):** Мониторинг и управление распределением электроэнергии.

#### 2. 1-Wire

**Принцип работы:**
1-Wire — это протокол передачи данных, использующий один провод для коммуникации между микроконтроллером и одним или несколькими устройствами, который также служит линией питания. Устройства на шине 1-Wire могут иметь уникальные серийные номера, что позволяет их идентификацию и работу с ними в режиме множественного доступа без необходимости предварительной настройки сети.

**Преимущества:**
- **Минимальное количество проводов:** Требуется только один провод для передачи данных и питания.
- **Уникальные идентификаторы:** Каждое устройство имеет уникальный серийный номер, упрощающий их идентификацию.
- **Низкое энергопотребление:** Идеально подходит для использования в приложениях с батарейным питанием.
- **Гибкость размещения:** Устройства могут быть размещены на значительном расстоянии друг от друга.

**Недостатки:**
- **Низкая скорость передачи данных:** Более медленная по сравнению с другими шинами, что ограничивает его применение.
- **Сложности с таймингами:** Требует точной настройки таймингов для обеспечения надёжной работы.
- **Ограниченная масштабируемость:** Сложности с поддержкой большого количества устройств на одной шине.

**Сфера применения:**
- **Системы мониторинга температуры:** Часто используется в термометрах и системах контроля климата.
- **Идентификация и аутентификация:** Авторизация доступа, например, в электронных ключах.
- **Системы управления аккумуляторами:** Мониторинг и управление зарядом в портативных устройствах.

#### 3. I²C (IIC, Inter-Integrated Circuit)

**Принцип работы:**
I²C — это двунаправленный протокол передачи данных, использующий два провода: SCL (Serial Clock Line) для синхронизации и SDA (Serial Data Line) для передачи данных. Протокол поддерживает множество ведомых устройств, управляемых одним или несколькими мастерами. Адресация устройств происходит через 7- или 10-битные адреса, что позволяет подключать до 128 устройств на одной шине.

**Преимущества:**
- **Простота подключения:** Требуется всего два провода, что упрощает монтаж.
- **Поддержка множественного мастера:** Может использоваться с несколькими мастерами на одной шине.
- **Встроенная арбитражность:** Позволяет избежать конфликтов при доступе к шине.
- **Широкая поддержка:** Множество микроконтроллеров и устройств поддерживают I²C.

**Недостатки:**
- **Ограниченная дальность:** Не подходит для длинных линий связи из-за ограничений по емкостной нагрузке.
- **Ограниченная скорость:** Стандартные режимы работы обеспечивают скорости до 400 кбит/с, что меньше, чем у более новых интерфейсов.
- **Проблемы с шумом:** Более чувствителен к электрическим помехам на длинных линиях.

**Сфера применения:**
- **Системы управления периферией:** Управление маломощными устройствами, такими как датчики, АЦП, ЦАП.
- **Потребительская электроника:** Управление различными модулями в телефонах, планшетах и ноутбуках.
- **Автомобильная электроника:** Не критичные к скорости доменные системы для управления и мониторинга.

#### 4. CAN (Controller Area Network)

**Принцип работы:**
CAN — это мульти-мастерный серийный протокол шины, разработанный для эффективного обмена сообщениями в условиях высоких помех, типичных для автомобильной промышленности. Сообщения, идентифицированные по уникальным ID, передаются по шине, и устройства с меньшим ID имеют более высокий приоритет. Это обеспечивает детерминированную передачу важных сообщений даже в условиях загруженной шины. Устройства на шине CAN могут отправлять, получать и обрабатывать сообщения без вмешательства хост-процессора благодаря аппаратной поддержке протокола.

**Преимущества:**
- **Высокая надежность:** Использование дифференциальной передачи данных увеличивает устойчивость к электромагнитным помехам.
- **Приоритетизация сообщений:** Использование идентификаторов сообщений для приоритетизации помогает обеспечить быструю обработку критически важных данных.
- **Гибкость и масштабируемость:** CAN поддерживает большое количество устройств и может работать с разными скоростями передачи данных.
- **Автоматическое исправление ошибок:** Встроенные механизмы для обнаружения и исправления ошибок повышают надежность передачи данных.

**Недостатки:**
- **Сложность:** Протокол и его реализация сложнее по сравнению с более простыми шинами, как I²C или SPI.
- **Ограниченная скорость передачи данных:** Максимальная скорость составляет 1 Мбит/с, что может быть недостаточно для некоторых высокоскоростных приложений.
- **Более высокая стоимость:** Аппаратная реализация CAN требует дополнительных затрат на микросхемы и разработку.

**Сфера применения:**
- **Автомобильная промышленность:** Системы управления двигателем, ABS, круиз-контроль и другие системы безопасности и управления.
- **Промышленная автоматизация:** Связь между различными контроллерами и устройствами на производстве.
- **Авионика:** Используется в сетях управления и мониторинга бортовых систем в самолетах.
- **Медицинское оборудование:** Связь между различными устройствами в критически важных медицинских системах.

| Технология | Преимущества                                              | Недостатки                                   | Основная сфера применения                          |
| ---------- | --------------------------------------------------------- | -------------------------------------------- | -------------------------------------------------- |
| Modbus RTU | Простота, надежность, широкая поддержка, низкая стоимость | Ограниченная длина сети, отсутствие шифровки | Промышленная автоматизация, BMS                    |
| 1-Wire     | Минимум проводов, уникальные ID, низкое энергопотребление | Низкая скорость, сложности с таймингами      | Мониторинг температуры, идентификация              |
| I²C        | Простота подключения, поддержка множественного мастера    | Ограниченная дальность и скорость, шум       | Управление периферией, потребительская электроника |
| CAN        | Надежность, приоритетизация, авто исправление ошибок      | Сложность, ограниченная скорость, стоимость  | Автомобильная промышленность, авионика             |

## Задание практической работы №6
### Часть 1. SHH-подключение
Подключитесь к консоли WirenBoard по протоколу SSH. Для этого используйте SSH-клиент PuTTy (или другой клиент)

```bash
ssh user@192.168.2.24
```
### Часть 2. Подписка на топик
При помощи улиты mosquitto_sub подпишитесь на сообщения нескольких датчиков стенда, согласно варианту:

#### 1. Датчик движения устройства WB-MSW v.3 (5)

```bash
mosquitto_sub -t "/devices/wb-msw-v3_21/controls/Max Motion" -t "/devices/wb-msw-v3_21/controls/Current Motion" -v -p 1883
```

#### 2. Качество воздуха VOC устройства WB-MS v.2 (12) (ИСПРАВИТЬ!)

```bash
mosquitto_sub -t "/devices/wb-ms_11/controls/Air Quality (VOC)" -v -p 1883
```

Иные устройства: датчик температуры v3

```bash
mosquitto_sub -t "/devices/wb-msw-v3_21/controls/Temperature" -v  -p 1883
```

Датчик температуры устройства WB-MS v.2 (12)

```bash
mosquitto_sub -t "/devices/wb-ms_11/controls/Temperature" -v  -p 1883
```

### Часть 3. Управление устройствами
Для управления устройством (изменения значения канала), необходимо отправить сообщение в топик `/devices/<device-id>/controls/<control-id>/on` (обратите внимание на /on в конце). Название топика можно также посмотреть в веб-интерфейсе контроллера во вкладке Settings – MQTT Channels. Это делается с помощью консольной команды `mosquitto_pub`.

Например, данная команда отправляет сообщение «1» (логическую единицу, «включить») в топик, соответствующий подключённому по RS-485 релейном модуле WM-MRM2 с адресом 130.
```c
~# mosquitto_pub -t "/devices/wb-mrm2_130/controls/Relay 1/on" -m "1"
```

Включите или измените поведение устройств посредством отправки сообщение в соответствующий топик согласно вариантам:

#### 1. Включите индикатор устройства WB-MSW v.3 (5)

```bash
mosquitto_pub -t "/devices/wb-gpio/controls/EXT1_R3A3/on" -m "1" -p 1883
```

#### 2. Включите подсветку кнопки 28

```bash
 mosquitto_pub -t "/devices/wb-mr3_56/controls/K3/on" -m "1" -p 1883
```

### Часть 4*. Сообщения MQTT с внешнего устройства
*Примечание. Работа выполняется только в случае подключения стендов к сети Интернет.*

Настройте MQTT-мост (т.е. пересылку всех сообщений MQTT на любой облачный MQTT брокер и обратно) или создайте собственный брокер MQTT.

Обязательно верните файл конфигурации mosquito.conf контроллера к изначальному состоянию после выполнения работы!

Процесс настройки приведен в [документации](https://wirenboard.com/wiki/MQTT#.D0.A0.D0.B0.D0.B1.D0.BE.D1.82.D0.B0_.D1.81_.D1.81.D0.BE.D0.BE.D0.B1.D1.89.D0.B5.D0.BD.D0.B8.D1.8F.D0.BC.D0.B8_MQTT_.D1.81_.D0.B2.D0.BD.D0.B5.D1.88.D0.BD.D0.B5.D0.B3.D0.BE_.D1.83.D1.81.D1.82.D1.80.D0.BE.D0.B9.D1.81.D1.82.D0.B2.D0.B0) к контроллеру WirenBoard.

ВНИМАНИЕ! Необходимо редактировать файл конфигурации, находящийся <ins>в домашней директории пользователя</ins> `user` (а не `/etc/mosquitto/mosquitto.conf`)!

```bash
mosquitto_sub -v -t "/devices/power_status/controls/Vin" -i Test_client -p 1883
```



