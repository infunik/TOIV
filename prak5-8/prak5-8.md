# Практическая работа №5 – Измерительные и исполнительные устройства в Интернете вещей
### Физические устройства Интернета вещей
Физические устройства Интернета вещей Физические устройства Интернета вещей чаще всего состоят из нескольких типов элементов:

![](../images/Pasted%20image%2020241118160525.png)

**Датчик** – чувствительный элемент, который контактирует с окружающей средой: измеряет показания, реагирует на объекты и создает сигнал об этом.

**Микроконтроллер** (или гейт) – специальная микросхема, предназначенная для управления различными электронными устройствами. Типичный микроконтроллер сочетает на одном кристалле функции процессора и периферийных устройств, содержит ОЗУ и (или) ПЗУ. По сути, это однокристальный компьютер, способный выполнять относительно простые задачи и реализовать логику работы физического устройства.

**Актуатор** – исполнительное устройство, например, *реле или транзистор*, способные что-то переключать – по сигналу от микроконтроллера или по дистанционной команде, которую примет радиомодуль. Например, если температура выйдет за допустимый предел, актуатор может включить вентиляцию или кондиционер.

Данный тип элементов Интернета вещей предназначен для воздействия на окружающую среду или определенный объект в ней.
К актуаторам относят:
- Сервоприводы
- Динамики
- Электронные замки
- Осветительные приборы
- Реле и транзисторы
- ИК-пульты

**Источник питания** – для работы микроконтроллера и подключенных к нему устройств необходимо питание. В зависимости от энергопотребления и задачи мы можем питать устройство от батарейки или от сети по проводу.

**Радиомодуль** – устройство для организации различных технологий беспроводной связи (например, GPRS, LTE, NB-IoT, GSM, Wi-Fi, Bluetooth и др.)

### Датчики и их устройство
Датчики – устройства, измеряющие физические характеристики объектов или окружающей среды (например, температуру, давление, наличие примесей в воздухе, положение в пространстве и т. д) и преобразующие ее в вид, удобный для дальнейшей обработки.

Датчики, выполненные на основе электронной техники, называются электронными датчиками. Отдельный датчик может измерять (контролировать) одну или одновременно несколько физических величин.

В состав датчика входят чувствительные и преобразовательные элементы.
- Измерительный преобразователь – средство измерений, в котором измеряемый сигнал преобразуется в сигнал другой формы, удобной для дальнейшей передачи, преобразования, обработки и хранения.
	- Первичный измерительный преобразователь – измерительный преобразователь, который взаимодействует непосредственно с исследуемым объектом.
- Чувствительный элемент – часть преобразовательного элемента средства измерений, первый элемент в измерительной цепи, находящийся под непосредственным воздействием измеряемой величины. В преобразовательном элементе средства измерений происходит одно из ряда последовательных преобразований величины.

Датчики являются элементом технических систем, предназначенных для измерения, сигнализации, регулирования, управления устройствами или процессами. Датчики преобразуют контролируемую величину (давление, температура, расход, концентрация, частота, скорость, перемещение, напряжение, электрический ток и т. п.) в сигнал (электрический, оптический, пневматический), удобный для измерения, передачи, преобразования, хранения и регистрации информации о состоянии объекта измерений

Исторически и логически датчики связаны с техникой измерений и измерительными приборами, например, термометры, расходомеры, барометры, прибор «авиагоризонт» и т. д. Обобщающий термин датчик укрепился в связи с развитием автоматических систем управления, как элемент обобщенной логической концепции датчик – устройство управления – исполнительное устройство – объект управления.

В автоматизированных системах управления датчики могут выступать в роли инициирующих устройств, приводя в действие оборудование, арматуру и программное обеспечение. Показания датчиков в таких системах, как правило, записываются на запоминающее устройство для контроля, обработки, анализа и вывода на дисплей или печатающее устройство. Огромное значение датчики имеют в робототехнике, где они выступают в роли рецепторов, посредством которых роботы и другие автоматические устройства получают информацию из окружающего мира и своих внутренних органов.

Основные характеристики датчиков:
- чувствительность (порог чувствительности) – наименьшее значение входной величины, приводящее к изменению измеряемой выходной
- погрешность выходного сигнала – определена для нормальных условий эксплуатации, при изменении условий окружающей среды, погрешность увеличивается
- диапазон измерения – минимально и максимально возможные значения величин, которые сможет детектировать датчик

### Классификация датчиков
По методу измерения:
- Активные (генераторные, сами воздействуют на окружающую среду)
- Пассивные (параметрические, окружающая среда воздействует на них)

По измеряемому параметру 
- Датчики давления
- Датчики расхода
- Уровня
- Температуры
- Датчик концентрации
- Радиоактивности (также именуются детекторами радиоактивности или излучений)
- Перемещения
- Положения
- Фотодатчики
- Датчик углового положения
- Датчик вибрации
- Датчик механических величин
- Датчик влажности

По характеру выходного сигнала
- Дискретные
- Аналоговые
- Цифровые
- Импульсные

По среде передачи: проводные и беспроводные. При этом датчики могут являться частью какого-либо прибора, тогда они называются интегральные, а могут представлять собой независимое устройство, так называемые элементные датчики.

По способу питания: автономные (работают от батареи) и подключенные к сети электропитания.

# Практическая работа №6 – Основы работы с протоколом MQTT. Брокераж сообщений
## MQTT протокол, основные особенности
MQTT (англ. message queuing telemetry transport) — упрощённый сетевой протокол, работающий поверх TCP/IP, ориентированный на обмен сообщениями между устройствами по принципу издатель-подписчик.

Протокол ориентируется на простоту в использовании, невысокую нагрузку на каналы связи, работу в условиях постоянной потери связи, лёгкую встраиваемость в любую систему. Основное предназначение — работа с телеметрией от различных датчиков и устройств. Использование шаблона подписчика обеспечивает возможность устройствам выходить на связь и публиковать сообщения, которые не были заранее известны или предопределены, в частности, протокол не вводит ограничений на формат передаваемых данных.

Главные особенности протокола MQTT:
- Компактный и легковесный — минимальные накладные расходы на пересылку данных, для экономии трафика.
- Устойчивость к потерям — гарантированная доставка в условиях нестабильных сетевых подключений.
- Асинхронный — позволяет обслуживать большое количество устройств, и не зависит от сетевых задержек.
- Поддержка QoS — возможность управлять приоритетом сообщений и гарантировать доставку сообщения адресату.
- Динамическая конфигурация — не требует предварительно согласования полей и форматов данных, может конфигурироваться «на лету».
- Работает за NAT — клиенты могут находиться за NAT, только сервер (брокер) должен иметь реальный IP. Позволяет обойтись без VPN и пробрасывания портов.
- Удобная адресация — поля данных имеют текстовые названия, понятные для человека. Не нужно запоминать цифровые адреса и битовые смещения.

Протокол MQTT работает на прикладном уровне поверх TCP/IP и использует по умолчанию 1883 порт (8883 при подключении через SSL).

![](../images/Pasted%20image%2020241118160629.png)

## Принцип работы MQTT
Обмен сообщениями в протоколе MQTT осуществляется между клиентом (client), который может быть издателем или подписчиком (publisher/subscriber) сообщений, и брокером (broker) сообщений (например, Mosquitto MQTT).

Брокер (Broker) — это центральный узел MQTT, обеспечивающий взаимодействие клиентов. Обмен данными между клиентами происходит только через брокера. В качестве брокера может выступать серверное ПО или контроллер. В его задачи входит получение данных от клиентов, обработка и сохранение данных, доставка данных клиентам, и контроль за доставкой сообщений.

#### Publisher/Subscriber
Для понимания разницы между Publisher и Subscriber разберем простой пример: `датчик влажности измеряет влажность в помещении, и если она опустилась ниже определенного уровня, включается увлажнитель воздуха`.

В данном случае датчик влажности выступает в роли Publisher: его задача сводится только к публикации данных в сторону брокера. Увлажнитель воздуха выступает в роли Subscriber: он подписывается на обновления данных о влажности и получает от брокера актуальные данные, при этом увлажнитель может сам решать, в какой момент включать увлажнение.

В этой схеме MQTT-клиенты, то есть датчик и увлажнитель, не знают о существовании друг друга, и не взаимодействуют напрямую. Брокер может получать данные из разных источников, проводить над ними манипуляции, например, рассчитывать среднее значение от нескольких датчиков, и уже обработанные данные возвращать подписчику

![](../images/Pasted%20image%2020241118160639.png)

При этом, асинхронность протокола MQTT предусматривает, что датчик и увлажнитель могут быть онлайн в разное время, терять пакеты, и быть недоступны. Брокер позаботится о том, чтобы сохранить в памяти последние данные, полученные от датчика, и обеспечить их доставку на увлажнитель.

Издатель отправляет данные на MQTT брокер, указывая в сообщении определенную тему, топик (topic). Подписчики могут получать разные данные от множества издателей в зависимости от подписки на соответствующие топики. 

Устройства MQTT используют определенные типы сообщений для взаимодействия с брокером, ниже представлены основные: 
- Connect – установить соединение с брокером
- Disconnect – разорвать соединение с брокером
- Publish – опубликовать данные в топик на брокере
- Subscribe – подписаться на топик на брокере
- Unsubscribe – отписаться от топика

![](../images/Pasted%20image%2020241118160648.png)

## Семантика топиков
Для идентификации сущностей в MQTT используются топики (или каналы). Топики состоят из UTF8-символов, и имеют древовидную структуру, похожую на файловую систему в UNIX. Это удобный механизм, позволяющий называть сущности в человекопонятном виде.

Пример топиков в MQTT: 
```c
# Датчик температуры на кухне
home/kitchen/temperature

# Датчик температуры в спальне
home/sleeping-room/temperature

# Датчик освещенности на улице
home/outdoor/light
```

Такой подход позволяет наглядно видеть, какие данные передаются, и удобно разрабатывать и отлаживать код, без необходимости запоминать цифровой адрес размещения данных

Иерархическая структура топиков имеет формат «дерева», что упрощает их организацию и доступ к данным. Топики состоят из одного или нескольких уровней, которые разделены между собой символом «/».

Пример топика, в который датчик температуры, расположенный в спальной комнате, публикует данные брокеру:
```c
/home/living-space/living-room1/temperature
```

Подписчик может так же получать данные сразу с нескольких топиков, для этого существуют wildcard. Они бывают двух типов: одноуровневые и многоуровневые. Для более простого понимания рассмотрим в примерах каждый из них:

1. Одноуровневый wildcard. Для его использования применяется символ «`+`» К примеру, нам необходимо получить данные о температуры во всех спальных комнатах:
```c
/home/living-space/+/temperature
```

В результате получаем данные с топиков:
```c
/home/living-space/living-room1/temperature
/home/living-space/living-room2/temperature
/home/living-space/living-room3/temperature
```

2. Многоуровневый wildcard. Для его использования применяется символ «`#`» К примеру, чтобы получить данные с различных датчиков всех спален в доме:

```c
/home/living-space/#
```

В результате получаем данные с топиков:
```c
/home/living-space/living-room1/temperature
/home/living-space/living-room1/light1
/home/living-space/living-room1/light2
/home/living-space/living-room1/humidity
/home/living-space/living-room2/temperature
/home/living-space/living-room2/light1
```

### Работа с MQTT в WirenBoard
Подробно о работе MQTT на контроллере WirenBoard вы можете ознакомиться в документации к оборудованию: https://wirenboard.com/wiki/MQTT

# Практическая работа №7 – Форматы представления данных
## Синтаксическая совместимость
Системы Интернета вещей часто характеризуется большим количеством разнородных компонентов, и для корректного взаимодействия этих компонентов (т.е. для обмена данным без потерь и повреждения) необходимо поддерживать синтаксическую совместимость.

Некоторые форматы представления данных особенно хорошо подходят для обмена данными между компонентами системы Интернета вещей и между различными системами. Примером таких форматов представления данных может служить XML (расширяемый язык разметки) и JSON.

## XML
XML (англ. eXtensible Markup Language) — расширяемый язык разметки. Рекомендован Консорциумом Всемирной паутины (W3C). Спецификация XML описывает XML- документы и частично описывает поведение XML-процессоров (программ, читающих XML-документы и обеспечивающих доступ к их содержимому). XML разрабатывался как язык с простым формальным синтаксисом, удобный для создания и обработки документов программами и одновременно удобный для чтения и создания документов человеком, с подчёркиванием нацеленности на использование в Интернете.

Язык называется расширяемым, поскольку он не фиксирует разметку, используемую в документах: разработчик волен создать разметку в соответствии с потребностями к конкретной области, будучи ограниченным лишь синтаксическими правилами языка. Расширение XML — это конкретная грамматика, созданная на базе XML и представленная словарём тегов и их атрибутов, а также набором правил, определяющих какие атрибуты и элементы могут входить в состав других элементов. Сочетание простого формального синтаксиса, удобства для человека, расширяемости, а также базирование на кодировках Юникод для представления содержания документов привело к широкому использованию как, собственно, XML, так и множества производных специализированных языков на базе XML в самых разнообразных программных средствах.

XML хранит данные в текстовом формате. Это обеспечивает независимый от программного и аппаратного обеспечения способ хранения, транспортировки и обмена данными. XML также облегчает расширение или обновление до новых операционных систем, новых приложений или новых браузеров без потери данных.

### Преимущества XML:
Поддержка метаданных Одним из самых больших преимуществ XML является то, что метаданные возможно помещать в теги в форме атрибутов (в JSON атрибуты будут добавлены как другие поля- члены в представлении данных, которые НЕ могут быть желательны). Визуализация браузера Большинство браузеров отображают XML в удобочитаемой и организованной форме. Древовидная структура XML в браузере позволяет пользователям естественным образом сворачивать отдельные элементы дерева. Эта функция будет особенно полезна при отладке. Поддержка смешанного контента Хорошим вариантом использования XML является возможность передачи смешанного контента в пределах одной и той же полезной нагрузки данных. Этот смешанный контент четко различается по разным тегам.

### Введение в XML
Простейший XML-документ выглядит следующим образом:

```xml
<?xml version="1.0" encoding="windows-1251"?> 
<book category="WEB"> 
	<title lang="en">Learning XML</title> 
	<author>Erik T. Ray</author> 
	<year>2003</year>
	<price></price>
</book>
```

Первая строка — это XML декларация. Здесь определяется версия XML (1.0) и кодировка файла. На следующей строке описывается корневой элемент документа `<book>` (открывающий тег). Следующие 4 строки описывают дочерние элементы корневого элемента ( `itle, author, year, price`). Последняя строка определяет конец корневого элемента `</book>` (закрывающий тег).

Документ XML состоит из элементов (elements). Элемент начинается открывающим тегом (start-tag) в угловых скобках, затем идет содержимое (content) элемента, после него записывается закрывающий тег (end-teg) в угловых скобках.

Информация, заключенная между тегами, называется содержимым или значением элемента: `<author>Erik T. Ray</author>`. Т.е. элемент author принимает значение Erik T. Ray. Элементы могут вообще не принимать значения.

Элементы могут содержать атрибуты, так, например, открывающий тег `<title lang="en">` имеет атрибут lang, который принимает значение en. Значения атрибутов заключаются в кавычки (двойные или ординарные).

Некоторые элементы, не содержащие значений, допустимо записывать без закрывающего тега. В таком случае символ / ставится в конце открывающего тега: `<name first="Иван" second="Петрович" />`

### Структура XML
XML документ должен содержать корневой элемент. Этот элемент является «родительским» для всех других элементов.

Все элементы в XML документе формируют иерархическое дерево. Это дерево начинается с корневого элемента и разветвляется на более низкие уровни элементов.

Все элементы могут иметь подэлементы (дочерние элементы):
```xml
<корневой>
	<потомок>
		<подпотомок>.....
		</подпотомок>
	</потомок>
</корневой>
```

### Правила синтаксиса (Валидность)
Структура XML документа должна соответствовать определенным правилам. XML- документ, отвечающий этим правилам, называется валидным (англ. Valid — правильный) или синтаксически верным. Соответственно, если документ не отвечает правилам, он является невалидным.

Основные правила синтаксиса XML:
1. Теги XML регистрозависимы — теги XML являются регистрозависимыми. Так, тег `<Letter>` не то же самое, что тег `<letter>`. Открывающий и закрывающий теги должны определяться в одном регистре:
```xml
<Message>Это неправильно</message>
<message>Это правильно </message>
```

2. XML элементы должны соблюдать корректную вложенность: 
```xml
<b><i>Некорректная вложенность</b></i>
<b><i>Корректная вложенность</i></b>
```

3. У XML документа должен быть корневой элемент — XML документ должен содержать один элемент, который будет родительским для всех других элементов. Он называется корневым элементом.
Примечание. В большинстве XML файлов отчетов для ФНС корневым элементом является `<Файл></Файл>`. После закрывающего тега `</Файл>` больше ничего быть не должно.

4. Значения XML атрибутов должны заключаться в кавычки:
```xml
<note date="12/11/2007">Корректная запись</note>
<note date=12/11/2007>Некорреткная запись</note>
```

### Сущности
Некоторые символы в XML имеют особые значения и являются служебными. Если вы поместите, например, символ `<` внутри XML элемента, то будет сгенерирована ошибка, так как парсер интерпретирует его, как начало нового элемента. В примере ниже будет сгенерирована ошибка, так как в значении `"ООО<Мосавтогруз>"` атрибута `НаимОрг` содержатся символы `<` и `>`.

```xml
<НПЮЛ ИННЮЛ="7718962261" КПП="771801001" НаимОрг="ООО<Мосавтогруз>"/>
```

Также ошибка будет сгенерирована и в слудющем примере, если название организации взять в обычные кавычки (английские двойные):
```xml
<НПЮЛ ИННЮЛ="7718962261" КПП="771801001" НаимОрг="ООО"Мосавтогруз""/>
```

Чтобы ошибки не возникали, нужно заменить символ `<` на его сущность. В XML существует 5 предопределенных сущностей:

![](../images/Pasted%20image%2020241118160711.png)

Примечание: Только символы `<` и `&` строго запрещены в XML. Символ `>` допустим, но лучше его всегда заменять на сущность.

Таким образом, корректными будут следующие формы записей:
```xml
<НПЮЛ ИННЮЛ="7718962261" КПП="771801001" НаимОрг="ООО&quot;Мосавтогруз&quot;"/>
```
или
```xml
<НПЮЛ ИННЮЛ="7718962261" КПП="771801001" НаимОрг="ООО«Мосавтогруз»"/>
```

В последнем примере английские двойные кавычки заменены на французские кавычки («ёлочки»), которые не являются служебными символами.

### Кодировки
И еще один важный момент, который стоит рассмотреть — кодировки. Существует множество кодировок. Самыми распространенными кириллическими кодировками являются Windows-1251 и UTF-8. Последняя является одним из стандартов, но большая часть ФНС отчетности имеет кодировку Windows-1251.

В XML файле кодировка объявляется в декларации:
```xml
<?xml version="1.0" encoding="windows-1251"?>
```

## JSON
JSON (англ. JavaScript Object Notation) — текстовый формат обмена данными, основанный на JavaScript.

Как и многие другие текстовые форматы, JSON легко читается людьми. Несмотря на происхождение от JavaScript (точнее, от подмножества языка стандарта ECMA-262 1999 года), формат считается независимым от языка и может использоваться практически с любым языком программирования. Для многих языков существует готовый код для создания и обработки данных в формате JSON.

### Преимущества JSON
1. Более подробная структурная информация в документе XML требует открытия и закрытия тегов, а JSON использует пары `имя / значение`, четко обозначенные `«{«и»}»` для объектов, `«[«и»]»` для массивов, `«,»` (запятую) для разделения пары и `«:»` (двоеточие) для отделения имени от значения. Можно легко различить число `1` и строку `"1"`, поскольку числа, строки (и логические значения) представлены по-разному в JSON. Можно легко различать отдельные элементы и коллекции одного размера (используя массивы JSON).
2. Малый размер сообщения При одинаковом объеме информации JSON почти всегда значительно меньше, что приводит к более быстрой передаче и обработке.
3. Близость к javascript JSON является подмножеством JavaScript, поэтому код для его анализа и упаковки вполне естественно вписывается в код JavaScript.
4. Проще представить значение null

### Синтаксис и структура JSON
Объект JSON имеет вид «ключ-значение» и обычно записывается в фигурных скобках. При работе с JSON все объекты хранятся в файле .json, но также они могут существовать как отдельные объекты в контексте программы.

Объект JSON выглядит так:
```json
{
	"first_name" : "John",
	"last_name" : "Smith",
	"location" : "London",
	"online" : true,
	"followers" : 987 
}
```

Это очень простой пример. Объект JSON может содержать множество строк.

Как видите, объект состоит из пар «ключ-значение», которые заключены в фигурные скобки. Большая часть данных в JSON записывается в виде объектов.

Между ключом и значением ставится двоеточие. После каждой пары нужно поставить запятую. В результате получается:
```json
"key" : "value", "key" : "value", "key": "value"
```

Ключ в JSON находится слева. Ключ нужно помещать в двойные кавычки. В качестве ключа можно использовать любую валидную строку. В рамках одного объекта все ключи должны быть уникальны. Ключ может содержать пробел (“first name”), но при программировании могут возникнуть проблемы с доступом к такому ключу. Потому вместо пробела лучше использовать подчеркивание (“first_name”).

Значения JSON находятся в правой части столбца. В качестве значения можно использовать любой простой тип данных:
- Строки
- Числа
- Объекты
- Массивы
- Логические данные (true или false)
- Ноль

Значения могут быть представлены и сложными типами данных (например, объектами или массивами JSON).

JSON поддерживает индивидуальный синтаксис каждого из перечисленных выше типов данных: если значение представлено строкой, то оно будет взято в кавычки, а если числом, то нет. Как правило, данные в файлах .json записываются в столбик, однако JSON можно записать и в строку:
```json
{ "first_name" : "John", "last_name": "Smith", "online" : true, }
```

Так обычно записываются данные JSON в файлы другого типа.

Записывая данные JSON в столбец, вы повышаете удобочитаемость файла (особенно если данных в файле много). JSON игнорирует пробелы между столбцами, потому с их помощью вы можете разделить данные на удобное для восприятия количество столбцов.
```json
{
	"first_name" : "John",
	"last_name" : "Smith",
	"online" : true
}
```

Обратите внимание: объекты JSON очень похожи на объекты JavaScript, но это не один и тот же формат. К примеру, в JavaScript можно использовать функции, а в JSON нельзя.

Главным преимуществом JSON является то, что данные в этом формате поддерживают многие популярные языки программирования, потому их можно быстро передать.

Теперь вы знакомы с базовым синтаксисом JSON. Но файлы JSON могут иметь сложную, иерархическую структуру, включающую в себя вложенные массивы и объекты.

### Сложные типы в JSON
JSON может хранить вложенные объекты и массивы, которые будут передаваться в качестве значения присвоенного им ключа.

**Вложенные объекты**

Ниже вы найдёте пример – файл users.json, в котором содержатся данные о пользователях.

Для каждого пользователя (“john”, “jesse”, “drew”, “jamie”) в качестве значения передаётся вложенный объект, который, в свою очередь, тоже состоит из ключей и значений.

**Примечание:** Первый вложенный объект JSON выделен красным.

```json
{
	" john" : {
		"username" : " John",
		"location" : "London",
		"online" : true,
		"followers" : 987
	},
	"jesse" : {
		"username" : "Jesse",
		"location" : "Washington", 
		"online" : false,
		"followers" : 432
	},
	"drew" : {
		"username" : "Drew", "location" : "Paris", "online" : false, "followers" : 321
	},
	"jamie" : {
		"username" : "Jamie", "location" : "Berlin", "online" : true, "followers" : 654 
	}
}
```


Обратите внимание: фигурные скобки используются и во вложенном, и в основном объекте. Запятые во вложенных объектах используются так же, как и в обычных.

**Вложенные массивы**

Данные можно вкладывать в JSON с помощью массивов JavaScript, которые будут передаваться как значения. В JavaScript в начале и в конце массива используются квадратные скобки ([ ]). Массив – это упорядоченный набор данных, который может содержать данные различных типов.

