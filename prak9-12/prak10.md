# Практическая работа №10 – Управление устройствами при помощи платформ Интернета вещей
### Логика
Цель раздела «Логика» заключается в повышении уровня абстракции: от работы с моделями и элементами устройства к созданию сценариев автоматического взаимодействия с ним. Каждый сценарий автоматизации — это алгоритм, который определяет логику поведения объекта. С помощью такого сценария можно отслеживать изменения в устройстве и, в зависимости от этих изменений, автоматически выполнять соответствующие действия без участия пользователя. Сценарий автоматизации основан на конечном автомате, состоящем из состояний и переходов между ними.

Конечный автомат (или детерминированный конечный автомат, ДКА) — это математическая модель, используемая для описания поведения систем с конечным числом состояний. Конечный автомат состоит из множества состояний, событий и правил, которые определяют, как система переходит из одного состояния в другое на основе событий или входных данных.

### Основные элементы конечного автомата
1. Конечное множество состояний — набор возможных состояний, в которых может находиться система. Каждое состояние описывает определённое положение или характеристику системы. Например, для системы безопасности дома состояния могут быть "Система активна" и "Система отключена".
2. Начальное состояние — это состояние, в котором система находится в самом начале. Для каждого конечного автомата оно одно.
3. Конечное множество событий или входных данных — события, которые приводят к изменению состояния системы. Эти события могут быть внешними (например, нажатие кнопки) или внутренними (например, изменение температуры).
4. Правила переходов или функция перехода — набор правил, которые определяют, как система переходит из одного состояния в другое в ответ на конкретное событие или входные данные. Переход всегда однозначно определён: при получении одного и того же события система всегда переходит в одно и то же состояние.
5. Конечное множество конечных состояний — определенные состояния, в которых система завершает выполнение своей логики. Это может быть состояние успешного завершения работы или сбоя.

### Пример работы конечного автомата
Представим простой автомат для турникета в метро:
- Состояния: "Заблокирован" и "Разблокирован".
- События: "Билет проведён" и "Прохождение через турникет".

Правила переходов:
1. Если турникет заблокирован и проведён билет, то он переходит в состояние "Разблокирован".
2. Если турникет разблокирован, и кто-то проходит через него, он возвращается в состояние "Заблокирован".
В этом примере при каждом событии система чётко определяет своё текущее состояние и действует в соответствии с правилами переходов.

### Инструкция по настройке файла конфигурации для подключения к демонстрационному стенду (чемодану)
Для подключения облачной платформы Rightech к демонстрационному стенду Wirenboard (чемодану) необходимо в домашней директории пользователя добавить конфигурацию в файл mosquitto.conf:

```
#rightech connect config
connection rightech
address dev.rightech.io:1883
clientid temp_1
try_private false
start_type automatic
topic /devices/имя_устройства/controls/параметр both
topic /devices/имя_устройства/controls/параметр both
```

**!!! Обратите внимание на то, что необходимо указывать конкретные топики устройств.**

Это связано с тем, что платформа Rightech имеет ограничение в 14400 пакетов на отправку в сутки от одного объекта. После превышения данной квоты, платформа блокирует объект на ограниченное время (до конца дня по UTC+0).

### Создание сценария автоматизации
Для создания нового автомата необходимо перейти на вкладку «Логика» и добавить автомат, нажав на «+». После нажатия на данную кнопку, откроется окно следующего вида:

![](../images/Pasted%20image%2020241215220630.png)

В данном окне необходимо заполнить следующие поля:
- Имя — наименование автомата;
- Описание — подробная характеристика автомата, заполняется при необходимости;
- Модель — выберите модель объекта, для которого будете формировать сценарий автоматизации. Если автомат будет включать в себя взаимодействие между несколькими объектами, то необходимо выбрать те модели, которые соответствуют этим объектам;
- Импорт — возможность импортировать готовый автомат в виде файла или по ссылке (не обязателен).

После нажатия кнопки «Создать» откроется новый автомат с несколькими элементами в рабочей области.

![](../images/Pasted%20image%2020241215220648.png)

Основные элементы рабочей области автомата:
1.	Зеленый круг – является обозначением начала исполнения сценария (используется в любом автомате).
2.	Инициализация логики – состояние инициализации сценария (присутствует в любом автомате).
3.	Новое состояние – в данном элементе указываются действия, которые должны быть выполнены на входе и выходе.
4.	Добавить событие (Переход) – В переходе задается событие (всегда) и условие (опционально), при которых происходит изменение состояний.
5.	Красный круг – является обозначением окончания исполнения сценария (данный элемент может не использоваться, если автомат предполагает циклическое выполнение без остановки).

![](../images/Pasted%20image%2020241215220712.png)

Карточка созданного автомата состоит из следующих компонентов:
1. Имя автомата
2. Описание автомата
3. Модель, используемая в автомате. Если моделей несколько, то рядом в круглых скобках указывается количество дополнительных моделей:
4. Количество объектов, добавленных в автомат. При нажатии на данный объект, применяется фильтр к списку объектов и показываются только те объекты, которые связаны с этим автоматом.

![](../images/Pasted%20image%2020241215220724.png)

Элементы в карточке состояний:
1.	Вход в состояние
2.	Выход из состояния
3.	Удаление состояния
4.	Название состояния
5.	Описание состояния
6.	Добавление действий, которые будут выполняться при входе в состояние
7.	Перечень выбранных действий на входе
8.	Добавление действий, которые будут выполняться при выходе из состояния
9.	Перечень выбранных действий на выходе
10.	Изменение размеров состояния

Чтобы добавить действие к состоянию, определите, когда оно должно быть выполнено: при входе в состояние или при выходе из него. Затем нажмите соответствующую кнопку, чтобы открыть полный список доступных действий, сформированный на основе заданной модели. Этот список включает как действия, предусмотренные для каждой модели, так и добавленные отдельные пользователем команды. Из выпадающего меню выберите одну или несколько команд, которые будут выполнены при входе в состояние или при выходе из него.

Действия при входе в состояние выполняются в момент перехода в это состояние из любого другого. Действия при выходе из состояния срабатывают, когда система покидает это состояние и переходит в другое.

Все действия на платформе поделены на три смысловые группы:
1.	Действия автомата – базовые действия каждого автомата:
	- Изменить значение;
	- Сгенерировать событие;
	- Таймер №... – команды управления таймером:
	- Запустить таймер №...;
	- Остановить таймер №...;
	- Планировщик №... – команды управления планировщиком:
	- Запустить планировщик №...;
	- Остановить планировщик №...;
2.	Регистрация событий – действия, направленные на фиксацию момента входа/выхода из состояния:
	- Показать сообщение;
	- Отправить HTTP-запрос;
	- Отправить e-mail;
	- Отправить SMS.
3.	Действия объекта – команды, которые можно отправить на объект:
	- Базовые – команды, присутствующие в модели по умолчанию.
	- Все остальные разделы во вкладке «Действия объекта» – команды, созданные пользователем.

![](../images/Pasted%20image%2020241215220825.png)

Рассмотрим пример цикличной логики на примере умной теплицы с томатами. В этой теплице установлен датчик температуры, и при достижении определённого значения температуры система автоматически открывает форточки для вентиляции. В данном случае вместо форточек можно представить, что включается вентилятор, обеспечивающий циркуляцию воздуха.

Когда температура в теплице поднимается выше заданного порога (например, выше 30°C), датчик фиксирует это, и система переходит в состояние «Охлаждение». В этом состоянии вентилятор включается, чтобы снизить температуру. Как только температура опустится до комфортного уровня (например, 25°C), датчик зафиксирует изменение, и система переключится в состояние «Ожидание», при котором вентилятор выключается. Таким образом, система поддерживает оптимальные условия для роста томатов, автоматически реагируя на изменение температуры и выполняя нужные действия без вмешательства человека. В данном случае логика автомата будет выглядеть следующим образом:

![](../images/Pasted%20image%2020241215220846.png)

А в параметрах карточки «События» (Переход) запишем следующие данные:

![](../images/Pasted%20image%2020241215220854.png)

Сравнивать параметры внутри перехода можно с:
1.	Заданной величиной в разделе «Значение»;
2.	Другим параметром, выбранным в разделе «Параметр»;
3.	Одним из уровней данного параметра, выбранным в разделе «Уровень»;
4.	Конфигурационным значением, выбранным в разделе «Конфигурация».

В одном переходе можно задать от одного до четырех условий. Их взаимодействие между собой конфигурируются с помощью кнопок «И» и «ИЛИ». При выборе «И» для выполнения перехода должны быть выполнены все условия, при выборе «ИЛИ» - любое из указанных

![](../images/Pasted%20image%2020241215220906.png)

После добавления перехода можно увидеть, что автоматически сформировалось описание об указанных условиях. Если изменить переход, то описание остается прежним и не меняется, его необходимо изменять вручную.

Поскольку в ходе логики автомата из примера необходимо изменять значение параметров состояния, необходимо воспользоваться командой «Изменить значение». Ее также необходимо использовать если необходимо изменять/заполнять параметры конфигурации или статуса. Данная команда предусматривает следующие функции:
1.	Прочитать параметр из конфигурации/состояния/статуса и записать его в исходном виде в другой параметр из конфигурации/состояния/статуса;
2.	Прочитать параметр из конфигурации/состояния/статуса, выполнить над ним некоторое выражение (прочитанное значение используется в формировании выражения в виде переменной $value) и записать полученное значение в параметр из конфигурации/состояния/статуса;
3.	Определить какое-то значение в выражении и записать его в параметр из конфигурации/состояния/статуса.

В рассмотренном примере считывается состояние вентилятора и записывается его новое состояние (противоположное).

![500](../images/Pasted%20image%2020241215220931.png)

После настройки всей логики необходимо выбрать объекты, к которым эта логика относится. Для этого необходимо выбрать объекты на соответствующей вкладке.

![](../images/Pasted%20image%2020241215220946.png)

Когда выбор объектов завершен, необходимо запустить автомат, статус автомата изменится, состояние будет зафиксировано, появится время запуска, время работы автомата и другое.

Если логика работы верная, то можно будет посмотреть результат на вкладке «Объекты»:

![](../images/Pasted%20image%2020241215220957.png)


